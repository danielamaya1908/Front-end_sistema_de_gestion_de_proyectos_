const API_URL = 'https://kw358s80-5000.use.devtunnels.ms/api/auth';

export const login = async (email: string, password: string): Promise<string> => {
  console.log('ğŸš€ === INICIO LOGIN FRONTEND ===');
  console.log('ğŸ“§ Email:', email);
  console.log('ğŸ” Password:', password ? `${password.length} caracteres` : 'NO PROPORCIONADO');
  console.log('ğŸŒ URL destino:', `${API_URL}/login`);
  
  const requestData = { email, password };
  console.log('ğŸ“¤ Datos a enviar:', requestData);
  
  try {
    console.log('ğŸŒ Realizando peticiÃ³n fetch...');
    
    const response = await fetch(`${API_URL}/login`, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify(requestData),
    });
    
    console.log('ğŸ“¡ Response recibida:');
    console.log('   - Status:', response.status);
    console.log('   - StatusText:', response.statusText);
    console.log('   - OK:', response.ok);
    console.log('   - Headers:', Object.fromEntries(response.headers.entries()));
    
    if (!response.ok) {
      console.log('âŒ Response no OK, obteniendo error...');
      
      try {
        const errorData = await response.json();
        console.error('âŒ Error del servidor:', errorData);
        throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
      } catch (parseError) {
        console.error('âŒ Error al parsear respuesta de error:', parseError);
        const textError = await response.text();
        console.error('âŒ Respuesta como texto:', textError);
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
    }
    
    console.log('âœ… Response OK, parseando JSON...');
    const data = await response.json();
    console.log('ğŸ“¥ Datos recibidos del servidor:', data);
    
    if (!data.token) {
      console.error('âŒ No se recibiÃ³ token en la respuesta');
      throw new Error('Token no recibido del servidor');
    }
    
    console.log('ğŸ‰ Login exitoso - Token recibido:', data.token.substring(0, 20) + '...');
    return data.token;
    
  } catch (error) {
    console.error('ğŸ’¥ Error en login frontend:');
    console.error('   - Mensaje:', error.message);
    console.error('   - Tipo:', error.constructor.name);
    console.error('   - Stack:', error.stack);
    throw error;
  } finally {
    console.log('ğŸ === FIN LOGIN FRONTEND ===\n');
  }
};

export const register = async (email: string, password: string): Promise<void> => {
  console.log('ğŸš€ === INICIO REGISTER FRONTEND ===');
  console.log('ğŸ“§ Email:', email);
  console.log('ğŸ” Password:', password ? `${password.length} caracteres` : 'NO PROPORCIONADO');
  
  try {
    const response = await fetch(`${API_URL}/register`, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({ email, password }),
    });
    
    console.log('ğŸ“¡ Register response:', response.status, response.statusText);
    
    if (!response.ok) {
      const errorData = await response.json();
      console.error('âŒ Error en register:', errorData);
      throw new Error(errorData.message || 'Registration failed');
    }
    
    console.log('âœ… Register exitoso');
  } catch (error) {
    console.error('ğŸ’¥ Error en register frontend:', error.message);
    throw error;
  } finally {
    console.log('ğŸ === FIN REGISTER FRONTEND ===\n');
  }
};

export const forgotPassword = async (email: string): Promise<void> => {
  console.log('ğŸš€ === INICIO FORGOT PASSWORD FRONTEND ===');
  console.log('ğŸ“§ Email:', email);
  
  try {
    const response = await fetch(`${API_URL}/forgot-password`, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({ email }),
    });
    
    console.log('ğŸ“¡ Forgot password response:', response.status, response.statusText);
    
    if (!response.ok) {
      const errorData = await response.json();
      console.error('âŒ Error en forgot password:', errorData);
      throw new Error(errorData.message || 'Failed to send recovery email');
    }
    
    console.log('âœ… Forgot password exitoso');
  } catch (error) {
    console.error('ğŸ’¥ Error en forgot password frontend:', error.message);
    throw error;
  } finally {
    console.log('ğŸ === FIN FORGOT PASSWORD FRONTEND ===\n');
  }
};